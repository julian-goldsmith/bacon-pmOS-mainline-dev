#include "qcom-msm8974.dtsi"
#include "qcom-pm8841.dtsi"
#include "qcom-pm8941.dtsi"
#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/input/input.h>
#include <dt-bindings/pinctrl/qcom,pmic-gpio.h>
#include <dt-bindings/clock/qcom,mmcc-msm8974.h>

/ {
	model = "OnePlus One";
	compatible = "oneplus,bacon", "qcom,msm8974";

	aliases {
		serial0 = &blsp1_uart1;
	};

	chosen {
		stdout-path = "serial0:115200n8";
	};

	smd {
		rpm {
			rpm_requests {
				pm8841-regulators {
					s1 {
						regulator-min-microvolt = <675000>;
						regulator-max-microvolt = <1050000>;
					};

					s2 {
						regulator-min-microvolt = <500000>;
						regulator-max-microvolt = <1050000>;
					};

					s3 {
						regulator-min-microvolt = <1050000>;
						regulator-max-microvolt = <1050000>;
					};
				};

				pm8941-regulators {
					vdd_l1_l3-supply = <&pm8941_s1>;
					vdd_l2_lvs1_2_3-supply = <&pm8941_s3>;
					vdd_l4_l11-supply = <&pm8941_s1>;
					vdd_l5_l7-supply = <&pm8941_s2>;
					vdd_l6_l12_l14_l15-supply = <&pm8941_s2>;
					vdd_l8_l16_l18_l19-supply = <&vreg_vph_pwr>;
					vdd_l9_l10_l17_l22-supply = <&vreg_boost>;
					vdd_l13_l20_l23_l24-supply = <&vreg_boost>;
					vdd_l21-supply = <&vreg_boost>;

					s1 {
						regulator-min-microvolt = <1300000>;
						regulator-max-microvolt = <1300000>;

						regulator-always-on;
						regulator-boot-on;
					};

					s2 {
						regulator-min-microvolt = <2150000>;
						regulator-max-microvolt = <2150000>;

						regulator-boot-on;
					};

					s3 {
						regulator-min-microvolt = <1800000>;
						regulator-max-microvolt = <1800000>;

						regulator-always-on;
						regulator-boot-on;
					};

					l1 {
						regulator-min-microvolt = <1225000>;
						regulator-max-microvolt = <1225000>;

						regulator-always-on;
						regulator-boot-on;
					};

					l2 {
						regulator-min-microvolt = <1200000>;
						regulator-max-microvolt = <1200000>;
					};

					l3 {
						regulator-min-microvolt = <1000000>;
						regulator-max-microvolt = <1225000>;
					};

					l4 {
						regulator-min-microvolt = <1225000>;
						regulator-max-microvolt = <1225000>;
					};

					l5 {
						regulator-min-microvolt = <1800000>;
						regulator-max-microvolt = <1800000>;
					};

					l6 {
						regulator-min-microvolt = <1800000>;
						regulator-max-microvolt = <1800000>;

						regulator-boot-on;
					};

					l7 {
						regulator-min-microvolt = <1800000>;
						regulator-max-microvolt = <1800000>;

						regulator-boot-on;
					};

					l8 {
						regulator-min-microvolt = <1800000>;
						regulator-max-microvolt = <1800000>;
					};

					l9 {
						regulator-min-microvolt = <1800000>;
						regulator-max-microvolt = <2950000>;
					};

					l10 {
						regulator-min-microvolt = <1800000>;
						regulator-max-microvolt = <2950000>;
					};

					l11 {
						regulator-min-microvolt = <1225000>;
						regulator-max-microvolt = <1350000>;
					};

					l12 {
						regulator-min-microvolt = <1800000>;
						regulator-max-microvolt = <1800000>;

						regulator-always-on;
						regulator-boot-on;
					};

					l13 {
						regulator-min-microvolt = <1800000>;
						regulator-max-microvolt = <2950000>;

						regulator-boot-on;
					};

					l14 {
						regulator-min-microvolt = <1800000>;
						regulator-max-microvolt = <1800000>;
					};

					l15 {
						regulator-min-microvolt = <2050000>;
						regulator-max-microvolt = <2050000>;
					};

					l16 {
						regulator-min-microvolt = <2700000>;
						regulator-max-microvolt = <2700000>;
					};

					l17 {
						regulator-min-microvolt = <2700000>;
						regulator-max-microvolt = <2850000>;
					};

					l18 {
						regulator-min-microvolt = <2850000>;
						regulator-max-microvolt = <2850000>;
					};

					l19 {
						regulator-min-microvolt = <2900000>;
						regulator-max-microvolt = <3350000>;
					};

					l20 {
						regulator-min-microvolt = <2950000>;
						regulator-max-microvolt = <2950000>;

						regulator-boot-on;

						regulator-system-load = <200000>;
						regulator-allow-set-load;
					};

					l21 {
						regulator-min-microvolt = <2950000>;
						regulator-max-microvolt = <2950000>;

						regulator-boot-on;
					};

					l22 {
						regulator-min-microvolt = <3000000>;
						regulator-max-microvolt = <3000000>;
					};

					l23 {
						regulator-min-microvolt = <2800000>;
						regulator-max-microvolt = <3000000>;
					};

					l24 {
						regulator-min-microvolt = <3075000>;
						regulator-max-microvolt = <3075000>;

						regulator-boot-on;
					};
				};
			};
		};
	};
};

&soc {
	serial@f991e000 {
		status = "ok";
	};

	pinctrl@fd510000 {
		sdhc1_pin_a: sdhc1-pin-active {
			clk {
				pins = "sdc1_clk";
				drive-strength = <4>;
				bias-disable;
			};

			cmd-data {
				pins = "sdc1_cmd", "sdc1_data";
				drive-strength = <4>;
				bias-pull-up;
			};
		};

		panel_pin: panel {
			te {
				pins = "gpio12";
				function = "mdp_vsync";

				drive-strength = <2>;
				bias-disable;
			};
		};

		hdmi_pin: hdmi {
			cec {
				pins = "gpio31";
				function ="hdmi_cec";
			};
			ddc {
				pins = "gpio32", "gpio33";
				function ="hdmi_ddc";
			};
			hpd {
				pins = "gpio34";
				function ="hdmi_hpd";
			};
		};
	};

	sdhci@f9824900 {
		status = "ok";

		vmmc-supply = <&pm8941_l20>;
		vqmmc-supply = <&pm8941_s3>;

		bus-width = <8>;
		non-removable;

		pinctrl-names = "default";
		pinctrl-0 = <&sdhc1_pin_a>;
	};

        usb@f9a55000 {
                status = "ok";

                phys = <&usb_hs1_phy>;
                phy-select = <&tcsr 0xb000 0>;
                extcon = <&smbb>, <&usb_id>;
                vbus-supply = <&chg_otg>;

                hnp-disable;
                srp-disable;
                adp-disable;

                ulpi {
                        phy@a {
                                status = "ok";

                                v1p8-supply = <&pm8941_l6>;
                                v3p3-supply = <&pm8941_l24>;

                                extcon = <&smbb>;
                                qcom,init-seq = /bits/ 8 <0x1 0x64>;
                        };
                };
        };

	mdss@fd900000 {
		interrupts = <0 72 0>;

		dsi0: dsi@fd922800 {
			vdd-supply = <&pm8941_l22>;

			ports {
				port@1 {
					dsi0_out: endpoint {
						remote-endpoint = <&panel_in>;
						data-lanes = <0 1 2 3>;
					};
				};
			};

			panel@0 {
				compatible = "jdi,1080p";

				reg = <0>;
				//power-supply = <&vreg_vsp>;
				//backlight = <&lp8566_wled>;

				port {
					panel_in: endpoint {
						remote-endpoint = <&dsi0_out>;
					};
				};
			};
		};
	};

/*
	gpu_opp_table: opp_table {
		compatible = "operating-points-v2";

		opp-533000000 {
			opp-hz = /bits/ 64 <533000000>;
		};
		opp-27000000 {
			opp-hz = /bits/ 64 <27000000>;
		};
	};

	gpu: adreno@fdb00000 {
		compatible = "qcom,adreno-330.2", "qcom-adreno";
		reg = <0xfdb00000 0x10000>;
		reg-names = "kgsl_3d0reg_memory";
		interrupts = <GIC_SPI 33 IRQ_TYPE_LEVEL_HIGH>;
		interrupt-names = "kgsl_3d0_irq";
		clock-names = "core", "iface", "mem_iface";
		clocks = <&mmcc OXILI_GFX3D_CLK>,
			 <&mmcc OXILICX_AHB_CLK>,
			 <&mmcc OXILICX_AXI_CLK>;

		power-domains = <&mmcc OXILICX_GDSC>;
		operating-points-v2 = <&gpu_opp_table>;

		// iommus = <&gpu_iommu 0>;
	};

    mdss: mdss@fd900000 {
        compatible = "qcom,mdss";
        reg = <0xfd900000 0x100>,
              <0xfd924000 0x1000>;
        reg-names = "mdss_phys", "vbif_phys";

        power-domains = <&mmcc MDSS_GDSC>;

        clocks = <&mmcc MDSS_AHB_CLK>,
             <&mmcc MDSS_AXI_CLK>,
             <&mmcc MDSS_VSYNC_CLK>;
        clock-names = "iface",
                  "bus",
                  "vsync";

        interrupts = <0 72 0>;

        interrupt-controller;
        #interrupt-cells = <1>;

        #address-cells = <1>;
        #size-cells = <1>;
        ranges;

        mdp: mdp@fd900000 {
            compatible = "qcom,mdp5";
            reg = <0xfd900100 0x22000>;
            reg-names = "mdp_phys";

            interrupt-parent = <&mdss>;
            interrupts = <0 0>;

            clocks = <&mmcc MDSS_AHB_CLK>,
                 <&mmcc MDSS_AXI_CLK>,
                 <&mmcc MDSS_MDP_CLK>,
                 <&mmcc MDSS_VSYNC_CLK>;
            clock-names = "iface",
                      "bus",
                      "core",
                      "vsync";

			// iommus = <&mdp_iommu 0>;

            ports {
                #address-cells = <1>;
                #size-cells = <0>;

                port@0 {
			reg = <0>;
			mdp5_intf3_out: endpoint {
				remote-endpoint = <&hdmi_in>;
			};
		};

                port@1 {
                    reg = <1>;
                    mdp5_intf1_out: endpoint {
                        remote-endpoint = <&dsi0_in>;
                    };
                };
            };
        };

        dsi0: dsi@fd922800 {
            compatible = "qcom,mdss-dsi-ctrl";
            reg = <0xfd922800 0x1f8>;
            reg-names = "dsi_ctrl";

            interrupt-parent = <&mdss>;
            interrupts = <4 0>;

            assigned-clocks =
                     <&mmcc BYTE0_CLK_SRC>,
                     <&mmcc PCLK0_CLK_SRC>;
            assigned-clock-parents =
                     <&dsi_phy0 0>,
                     <&dsi_phy0 1>;

            clocks = <&mmcc MDSS_MDP_CLK>,
					 <&mmcc MDSS_AHB_CLK>,
					 <&mmcc MDSS_AXI_CLK>,
					 <&mmcc MDSS_BYTE0_CLK>,
					 <&mmcc MDSS_PCLK0_CLK>,
					 <&mmcc MDSS_ESC0_CLK>,
					 <&mmcc MMSS_MISC_AHB_CLK>;
            clock-names = "mdp_core",
                      "iface",
                      "bus",
                      "byte",
                      "pixel",
                      "core",
                      "core_mmss";

            phys = <&dsi_phy0>;
            phy-names ="dsi-phy";

            vdda-supply = <&pm8941_l2>;
            vdd-supply = <&pm8941_l22>;
            vddio-supply = <&pm8941_l12>;

            #address-cells = <1>;
            #size-cells = <0>;

            ports {
                #address-cells = <1>;
                #size-cells = <0>;

                port@0 {
                    reg = <0>;
                    dsi0_in: endpoint {
                        remote-endpoint = <&mdp5_intf1_out>;
                    };
                };

                port@1 {
                    reg = <1>;
                    dsi0_out: endpoint {
                        remote-endpoint = <&panel_in>;
                        data-lanes = <0 1 2 3>;
                    };
                };
            };

            panel: panel@0 {
                reg = <0>;
                compatible = "jdi,1080p";

                // backlight?, reset?, enable?

                disp-te-gpios = <&msmgpio 12 0>;

                pinctrl-names = "default";
                pinctrl-0 = <&panel_pin>;

                port {
                    panel_in: endpoint {
                        remote-endpoint = <&dsi0_out>;
                    };
                };
            };
        };

        dsi_phy0: dsi-phy@fd922a00 {
            compatible = "qcom,dsi-phy-28nm-hpm";
            qcom,dsi-phy-index = <0>;
            reg-names =
                "dsi_pll",
                "dsi_phy",
                "dsi_phy_regulator";
            reg = <0xfd922a00 0xd4>,
                  <0xfd922b00 0x280>,
                  <0xfd922d80 0x30>;

            #clock-cells = <1>;

            clocks = <&mmcc MDSS_AHB_CLK>;
            clock-names = "iface";

            vddio-supply = <&pm8941_l12>;

            #phy-cells = <0>;
        };

        hdmi: hdmi-tx@fd922100 {
		status = "disabled";
		compatible = "qcom,hdmi-tx-8974";
		reg =	<0xfd922100 0x35C>,
			<0xfc4b8000 0x60F0>;
		reg-names = "core_physical",
				"qfprom_physical",
				"hdcp_physical";

		interrupt-parent = <&mdss>;
		interrupts = <8 IRQ_TYPE_LEVEL_HIGH>; // 8 ?

		clocks = <&mmcc MDSS_MDP_CLK>,
			 <&mmcc MDSS_AHB_CLK>,
			 <&mmcc MDSS_HDMI_CLK>,
			 <&mmcc MDSS_HDMI_AHB_CLK>,
			 <&mmcc MDSS_EXTPCLK_CLK>;
		clock-names =
			"mdp_core",
			"iface",
			"core",
			"alt_iface",
			"extp";

		power-domains = <&mmcc MDSS_GDSC>;
		// hpd-gdsc-supply = <&gdsc_mdss>;
		hpd-5v-supply = <&pm8941_lvs2>; // mvs2
		core-vdda-supply = <&pm8941_l12>;
		core-vcc-supply = <&pm8941_s3>;

		phys = <&hdmi_phy>;
		phy-names = "hdmi_phy";
		#sound-dai-cells = <0>;

		ports {
			#address-cells = <1>;
			#size-cells = <0>;

			port@0 {
				reg = <0>;
				hdmi_in: endpoint {
					remote-endpoint = <&mdp5_intf3_out>;
				};
			};
		};
	};

	hdmi_phy: hdmi-phy@fd922100 {
		compatible = "qcom,hdmi-phy-8974";
		reg = <0xfd922500 0x7C>;
		reg-names = "hdmi_phy";

		clocks = <&mmcc MDSS_AHB_CLK>,
			 <&mmcc MDSS_HDMI_AHB_CLK>;
		clock-names = "iface",
				  "alt_iface";

		core-vdda-supply = <&pm8941_l12>;
		core-vddio-supply = <&pm8941_s3>; // not right?

		pinctrl-names = "default";
		pinctrl-0 = <&hdmi_pin>;

		#phy-cells = <0>;
	};
    };
*/

	// look at the castor dts in the wip/8974-iommu branch of andersson/kernel on github
	// that fork is old, look at flto/linux
	// flto uses the lge-nexus5-hammerhead device to test with
};
